# SmartPromptBox Pro

&#x20; &#x20;

AI-’∏’æ ’°’∑’≠’°’ø’∏’≤ **Telegram Bot**’ù ’ø÷Ä’°’¥’°’§÷Ä’∏÷Ç’©’µ’°’∂ ’æ÷Ä’° ’∞’´’¥’∂’æ’°’Æ ’•÷Ä’£’•÷Ä’´/÷Ü’´’¨’¥’•÷Ä’´ ’°’º’°’ª’°÷Ä’Ø’∂’•÷Ä’∏’æ, LLM-’¶÷Ä’∏÷Ç’µ÷Å’∏’æ ’∞’´’∑’∏’≤’∏÷Ç’©’µ’°’¥’¢, ’∂’Ø’°÷Ä’´ ’£’•’∂’•÷Ä’°÷Å’´’°’µ’∏’æ ÷á ’°’¥’¢’∏’≤’ª’°’Ø’°’∂ **CI/CD** ’∞’∏’Ω÷Ñ’∏’æ÷â

> README_AM-’® **’Ä’°’µ’•÷Ä’•’∂** ’ß÷â ‘±’∂’£’¨’•÷Ä’•’∂ ’ø’°÷Ä’¢’•÷Ä’°’Ø’® ’∂’∏÷Ç’µ’∂’∫’•’Ω ’∂’•÷Ä’°’º’æ’°’Æ ’ß repository-’∏÷Ç’¥÷â

---

## ‘≤’∏’æ’°’∂’§’°’Ø’∏÷Ç’©’µ’∏÷Ç’∂

- [‘±’Ø’∂’°÷Ä’Ø](#-’°’Ø’∂’°÷Ä’Ø)
- [’Ä’°’ø’Ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä](#-’∞’°’ø’Ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä)
- [’É’°÷Ä’ø’°÷Ä’°’∫’•’ø’∏÷Ç’©’µ’∏÷Ç’∂](#-’≥’°÷Ä’ø’°÷Ä’°’∫’•’ø’∏÷Ç’©’µ’∏÷Ç’∂)
- [’è’•’≠’∂’∏’¨’∏’£’´’°’∂’•÷Ä](#-’ø’•’≠’∂’∏’¨’∏’£’´’°’∂’•÷Ä)
- [‘π’≤’©’°’∫’°’∂’°’Ø’∂’•÷Ä’´ ’Ø’°’º’∏÷Ç÷Å’æ’°’Æ÷Ñ](#-’©’≤’©’°’∫’°’∂’°’Ø’∂’•÷Ä’´-’Ø’°’º’∏÷Ç÷Å’æ’°’Æ÷Ñ)
- [’Ü’°’≠’°’∫’°’µ’¥’°’∂’∂’•÷Ä](#-’∂’°’≠’°’∫’°’µ’¥’°’∂’∂’•÷Ä)
- [’á÷Ä’ª’°’∫’°’ø’´ ÷É’∏÷É’∏’≠’°’Ø’°’∂’∂’•÷Ä (.env)](#-’∑÷Ä’ª’°’∫’°’ø’´-÷É’∏÷É’∏’≠’°’Ø’°’∂’∂’•÷Ä-env)
- [‘±÷Ä’°’£ ’£’∏÷Ä’Æ’°÷Ä’Ø’∏÷Ç’¥ (’è’•’≤’°’µ’´’∂)](#-’°÷Ä’°’£-’£’∏÷Ä’Æ’°÷Ä’Ø’∏÷Ç’¥-’ø’•’≤’°’µ’´’∂)
- [Docker / Compose](#-docker--compose)
- [Makefile (’®’Ω’ø ÷Å’°’∂’Ø’∏÷Ç’©’µ’°’∂)](#-makefile-’®’Ω’ø-÷Å’°’∂’Ø’∏÷Ç’©’µ’°’∂)
- [’ç’¨’•’∑ ’∞÷Ä’°’¥’°’∂’∂’•÷Ä](#-’Ω’¨’•’∑-’∞÷Ä’°’¥’°’∂’∂’•÷Ä)
- [‘π’•’Ω’ø’°’æ’∏÷Ä’∏÷Ç’¥](#-’©’•’Ω’ø’°’æ’∏÷Ä’∏÷Ç’¥)
- [CI (GitHub Actions)](#-ci-github-actions)
- [CD (Self-hosted)](#-cd-self-hosted)
- [DevOps / Ansible Deploy](#-devops--ansible-deploy)
- [’ç÷Ñ÷Ä’´’∂’∑’∏’©’•÷Ä](#-’Ω÷Ñ÷Ä’´’∂’∑’∏’©’•÷Ä)
- [’è’æ’µ’°’¨’∂’•÷Ä’´ ’∑’•÷Ä’ø](#-’ø’æ’µ’°’¨’∂’•÷Ä’´-’∑’•÷Ä’ø)
- [FSM ’æ’´’≥’°’Ø’∂’•÷Ä](#-fsm-’æ’´’≥’°’Ø’∂’•÷Ä)
- [‘±’º’∏’≤’ª’∏÷Ç’©’µ’∏÷Ç’∂ / Smoke](#-’°’º’∏’≤’ª’∏÷Ç’©’µ’∏÷Ç’∂--smoke)
- [’Ñ’´’ª’°’∂’Ø’µ’°’¨’∂’•÷Ä](#-’¥’´’ª’°’∂’Ø’µ’°’¨’∂’•÷Ä)
- [‘±’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂](#-’°’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂)
- [’è’°÷Ä’¢’•÷Ä’°’Ø’°’æ’∏÷Ä’∏÷Ç’¥ ÷á ‘π’∏’≤’°÷Ä’Ø’∏÷Ç’¥’∂’•÷Ä](#-’ø’°÷Ä’¢’•÷Ä’°’Ø’°’æ’∏÷Ä’∏÷Ç’¥-÷á-’©’∏’≤’°÷Ä’Ø’∏÷Ç’¥’∂’•÷Ä)
- [‘Ω’°÷É’°’∂’∏÷Ç’¥’∂’•÷Ä’´ ’∏÷Ç’≤’•÷Å’∏÷Ç’µ÷Å](#-’≠’°÷É’°’∂’∏÷Ç’¥’∂’•÷Ä’´-’∏÷Ç’≤’•÷Å’∏÷Ç’µ÷Å)
- [’Ä’è’Ä](#-’∞’©’∞)
- [’ë’°’∂’Ø’°’¨’´ ’¢’°÷Ä’•’¨’°’æ’∏÷Ç’¥’∂’•÷Ä](#-÷Å’°’∂’Ø’°’¨’´-’¢’°÷Ä’•’¨’°’æ’∏÷Ç’¥’∂’•÷Ä)
- [’Ü’•÷Ä’§÷Ä’∏÷Ç’¥’∂’•÷Ä](#-’∂’•÷Ä’§÷Ä’∏÷Ç’¥’∂’•÷Ä)
- [‘º’´÷Å’•’∂’¶’´’°](#-’¨’´÷Å’•’∂’¶’´’°)

---

## üìå ‘±’Ø’∂’°÷Ä’Ø

**SmartPromptBox Pro** ‚Äî ’¥’∏’§’∏÷Ç’¨’°’µ’´’∂ Telegram bot’ù ’£’∏÷Ä’Æ’∂’°’Ø’°’∂, ’¢’°÷Ä’±÷Ä ’∏÷Ä’°’Ø’´ AI ’∞’∂’°÷Ä’°’æ’∏÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’∏’æ‚Ä§

- ‘∏’∂’ø÷Ä’∏÷Ç’¥ ’•’Ω **’ø÷Ä’°’¥’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂**, ’°’∂’¥’´’ª’°’∫’•’Ω ’Ω’ø’°’∂’∏÷Ç’¥ ’•’Ω **’•÷Ä’£’•÷Ä, ÷Ü’´’¨’¥’•÷Ä, ’¥’•’ª’¢’•÷Ä’∏÷Ç’¥’∂’•÷Ä**, ’∂’°÷á **’∂’Ø’°÷Ä’´ prompt-’∂’•÷Ä**÷â
- **’Ä’´’∑’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’¶÷Ä’∏÷Ç’µ÷Å**’ù SQLite-’´ ’æ÷Ä’°’ù ’Ø’∏’∂’ø’•÷Ñ’Ω’ø’´ ’∫’°’∞’∫’°’∂’∏÷Ç’¥’∏’æ÷â
- **’Ü’Ø’°÷Ä’´ ’£’•’∂’•÷Ä’°÷Å’´’°**’ù ’∫’°÷Ä’¶ ’ø’•÷Ñ’Ω’ø’°’µ’´’∂ ’∞÷Ä’°’∞’°’∂’£’∂’•÷Ä’´÷Å÷â
- ’é’Ω’ø’°’∞ deploy’ù ’≠’´’Ω’ø **CI** (lint, types, security, tests, build) ÷á ’°’æ’ø’∏’¥’°’ø **CD**÷â

---

## ‚ú® ’Ä’°’ø’Ø’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä

- **üß† Mood Assistant** ‚Äî ’ø÷Ä’°’¥’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ ’®’∂’ø÷Ä’•’¨’∏÷Ç÷Å ’∞’•’ø’∏ bot-’® ’°’º’°’ª’°÷Ä’Ø’∏÷Ç’¥ ’ß’ù
  - 5 ’•÷Ä’£, 5 ÷Ü’´’¨’¥, 5 ’¥’•’ª’¢’•÷Ä’∏÷Ç’¥
  - 2 ’∂’Ø’°÷Ä’´ prompt (+ ’Ø’°’¥’®’∂’ø÷Ä’∏’æ ’£’•’∂’•÷Ä’°÷Å’´’°)
- **üéµ ‘µ÷Ä’£’•÷Ä** ‚Äî ’©’•’¥’°’ø’´’Ø ’∞’°’æ’°÷Ñ’°’Æ’∏÷Ç’∂’•÷Ä ÷á ’°÷Ä’°’£ ’°’º’°’ª’°÷Ä’Ø’∂’•÷Ä (YouTube ’∞’≤’∏÷Ç’¥’∂’•÷Ä’∏’æ)
- **üé¨ ’ñ’´’¨’¥’•÷Ä ÷á ’ç’•÷Ä’´’°’¨’∂’•÷Ä** ‚Äî ’®’Ω’ø ’™’°’∂÷Ä’´/’æ’•÷Ä’∂’°’£÷Ä’´/’ø÷Ä’°’¥’°’§÷Ä’∏÷Ç’©’µ’°’∂, ’∞’°÷Ä’∏÷Ç’Ω’ø ÷Ñ’°÷Ä’ø’•÷Ä’∏’æ
- **ü§ñ GPT ‘∂÷Ä’∏÷Ç’µ÷Å ’∞’´’∑’∏’≤’∏÷Ç’©’µ’°’¥’¢** ‚Äî ’¶÷Ä’∏÷Ç’µ÷Å’∂’•÷Ä’® ’∫’°’∞’æ’∏÷Ç’¥ ’•’∂ SQLite-’∏÷Ç’¥’ù ’Ø’∏’∂’ø’•÷Ñ’Ω’ø’´ ’∞’°’¥’°÷Ä
- **üé® ’Ü’Ø’°÷Ä ’£’•’∂’•÷Ä’°÷Å’´’°** ‚Äî ’∫’°’ø’Ø’•÷Ä’∂’•÷Ä ’ø’•÷Ñ’Ω’ø’°’µ’´’∂ prompt-’∂’•÷Ä’´÷Å
- **üß™ ‘π’•’Ω’ø’•÷Ä** ‚Äî unit / integration / e2e + input-sanitization
- **üê≥ Dockerized** ‚Äî dev/prod ’∫’°’ø’Ø’•÷Ä’∂’•÷Ä + Compose, healthcheck-’•÷Ä’∏’æ
- **‚öôÔ∏è CI/CD** ‚Äî ruff + mypy + pip-audit + unit tests + Docker build + Compose smoke; Telegram ’∂’∏’ø’´÷Ü’´’Ø’°÷Å’´’°’∂’•÷Ä

---

## üß± ’É’°÷Ä’ø’°÷Ä’°’∫’•’ø’∏÷Ç’©’µ’∏÷Ç’∂

**‘≤’°÷Ä’±÷Ä ’¥’°’Ø’°÷Ä’§’°’Ø’´ ’¢’°’≤’°’§÷Ä’´’π’∂’•÷Ä**

- `telegram_bot/` ‚Äî aiogram v3 ’∞’°’æ’•’¨’æ’°’Æ (routers, handlers, keyboards)
- `llm/` ‚Äî LLM adapters (mood inference, songs/movies/series pickers, image gen)
- `data/` ‚Äî ’¥’∏’§’•’¨’∂’•÷Ä ÷á ’∞’´’∑’∏’≤’∏÷Ç’©’µ’°’∂ persistence
- `utils/` ‚Äî ÷Ö’£’∂’°’Ø’°’∂ ’£’∏÷Ä’Æ’´÷Ñ’∂’•÷Ä (retry, summarizer, logging)
- `devops/` ‚Äî Dockerfile-’∂’•÷Ä, Compose stacks, Ansible deploy

**’Ä’∏’Ω÷Ñ**

1. ’ï’£’ø’°’ø’•÷Ä’® ’Ω’•’≤’¥’∏÷Ç’¥ ’ß ’¥’•’∂’µ’∏÷Ç’´ ’Ø’∏’≥’°’Ø’® (÷Ö÷Ä‚Ä§ *Mood Assistant*).
2. Handler-’® ’Ω’ø’∏÷Ç’£’∏÷Ç’¥ ’ß input-’® ‚Üí ’Ø’°’∂’π’∏÷Ç’¥ ’ß LLM/’Ø’°’¥ curated provider (retry-’∏’æ).
3. ’ä’°’ø’°’Ω’≠’°’∂’® ’±÷á’°’π’°÷É’æ’∏÷Ç’¥ ’ß ÷á ’∏÷Ç’≤’°÷Ä’Ø’æ’∏÷Ç’¥ ’ß Telegram.
4. ‘∂÷Ä’∏÷Ç’µ÷Å’´ ’§’•’∫÷Ñ’∏÷Ç’¥’ù ’¥’•’Ω’´’ª’∂’•÷Ä’® ’∫’°’∞’æ’∏÷Ç’¥ ’•’∂ **UserMemory**-’∏÷Ç’¥ ÷á ’®’Ω’ø ’Ø’°÷Ä’´÷Ñ’´’ù ’°’¥÷É’∏÷É’æ’∏÷Ç’¥÷â

---

## üì¶ ’è’•’≠’∂’∏’¨’∏’£’´’°’∂’•÷Ä

- **Python 3.10**, **aiogram 3**, **OpenAI API**
- **SQLAlchemy + SQLite**
- **Docker / Docker Compose**
- **GitHub Actions**

---

## üóÇÔ∏è ‘π’≤’©’°’∫’°’∂’°’Ø’∂’•÷Ä’´ ’Ø’°’º’∏÷Ç÷Å’æ’°’Æ÷Ñ

```text
app/
  __init__.py
  main.py
  meta.py
  states/
    __init__.py
    gpt_states.py
  scripts/
    __init__.py
    init_db.py
  data/
    __init__.py
    database.py
    db_session_tracker.py
    memory_service.py
    models/
      __init__.py
      base.py
      memory_model.py
      session_model.py
  llm/
    __init__.py
    assistant.py
    song_llm.py
    movie_picker.py
    series_picker.py
    mood_inferencer.py
    image_generator.py
    img_generator.py
    text_utils.py
  telegram_bot/
    __init__.py
    bot.py
    menu.py
    handlers/
      gpt_memory_chat_handler.py
      img_handler.py
      misc_commands.py
      mood_handler.py
      movie_menu_handler.py
      random_songs_handler.py
      series_menu_handler.py
    middlewares/
      __init__.py
      errors.py
      logging.py
      request_id.py
  utils/
    __init__.py
    logging_config.py
    retry.py
    summarizer.py
    trivial_check.py

devops/
  ansible/
    ansible.cfg
    inventory/hosts.ini
    playbooks/deploy.yml
    roles/deploy_app/tasks/main.yml
  compose/
    docker-compose.dev.yml
    docker-compose.prod.yml
  docker/
    app/Dockerfile
    app/Dockerfile.dev

.github/workflows/
  ci.yml
  cd.yml

tests/
  conftest.py
  smoke/
  unit/
    test_data/
    test_llm/
    test_states/
    test_telegram_bot/
    test_utils/
  integration/
    test_handler_llm/
  e2e/
  security/
  regression/
  performance/

root files: requirements.txt, requirements-dev.txt, .env.example, .dockerignore, .gitignore, mypy.ini, README.md
```

---

## ‚úÖ ’Ü’°’≠’°’∫’°’µ’¥’°’∂’∂’•÷Ä

- **Python 3.10**
- **Telegram Bot Token** (@BotFather)
- **OpenAI API Key**
- **Docker & Docker Compose** (’®’Ω’ø ÷Å’°’∂’Ø’∏÷Ç’©’µ’°’∂)

---

## üîê ’á÷Ä’ª’°’∫’°’ø’´ ÷É’∏÷É’∏’≠’°’Ø’°’∂’∂’•÷Ä (.env)

’ç’ø’•’≤’Æ’´÷Ä `.env` (’ø’•’Ω’ù `.env.example`).

| ‘≤’°’∂’°’¨’´’∂                            | ’Ü’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂                   |
| ---------------------------------- | -------------------------------- |
| `OPENAI_API_KEY`                   | OpenAI ’£’°’≤’ø’∂’°’¢’°’º                 |
| `TELEGRAM_BOT_TOKEN`               | ’Ä’´’¥’∂’°’Ø’°’∂ bot token               |
| `TELEGRAM_BOT_TOKEN_TEST_NOTIFIER` | CI/CD notifier token             |
| `TELEGRAM_CHAT_ID`                 | CI/CD ’¨’∏’£’•÷Ä’´ ’∞’°’Ω÷Å’•’°’ø’•÷Ä           |
| `DATABASE_URL`                     | ÷Ö÷Ä’´’∂’°’Ø’ù `sqlite:///db/memory.db` |
| `LOG_LEVEL`                        | `INFO` (’¨’º’•’¨’°’µ’∂), `DEBUG`        |
| `DISABLE_TELEGRAM`                 | `0`’ù bot-’® ’¥’´’°÷Å÷Ä’°’Æ               |
| `BOT_NAME`                         | ’ë’∏÷Ç÷Å’°’§÷Ä’æ’∏’≤ ’°’∂’∏÷Ç’∂’® `/about`-’∏÷Ç’¥   |
| `BOT_VERSION`                      | ’è’°÷Ä’¢’•÷Ä’°’Ø’® `/about`-’∏÷Ç’¥           |

---

## üöÄ ‘±÷Ä’°’£ ’£’∏÷Ä’Æ’°÷Ä’Ø’∏÷Ç’¥ (’è’•’≤’°’µ’´’∂)

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env  # ’¨÷Ä’°÷Å÷Ä’∏÷Ç ’¢’°’∂’°’¨’´’∂’•÷Ä’®
python -m app.scripts.init_db   # DB ’´’∂’´÷Å’´’°’¨’´’¶’°÷Å’´’° (’¥’´’°’∂’£’°’¥’µ’°)
python -m app.telegram_bot.bot  # ’£’∏÷Ä’Æ’°÷Ä’Ø’∏÷Ç’¥ bot-’®
```

**’ï’£’ø’°’Ø’°÷Ä ’∞÷Ä’°’¥’°’∂’∂’•÷Ä**

```bash
ruff .        # lint
mypy app      # typing
PYTHONPATH=. pytest -q  # tests
```

---

## üê≥ Docker / Compose

**Development**

```bash
docker compose -f devops/compose/docker-compose.dev.yml up --build
```

**Production**

```bash
docker compose -f devops/compose/docker-compose.prod.yml up -d --build
```

’Ü’∑’∏÷Ç’¥’∂’•÷Ä

- Healthcheck-’´ ’∫’°÷Ä’¶ ’ø’°÷Ä’¢’•÷Ä’°’Ø
  ```dockerfile
  HEALTHCHECK CMD python -c "import app; print('ok')"
  ```
  ’Ø’°’¥’ù utility-’∏’æ
  ```dockerfile
  HEALTHCHECK CMD python -c "from app.utils.trivial_check import ok; import sys; sys.exit(0 if ok() else 1)"
  ```
- SQLite-’´ ÷Ü’°’µ’¨’•÷Ä’® mount ’•’∂ `./db/` ’∫’°’∂’°’Ø’∏÷Ç’¥

---

## üß∞ Makefile (’®’Ω’ø ÷Å’°’∂’Ø’∏÷Ç’©’µ’°’∂)

’Ä’°÷Ä’¥’°÷Ä’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä’ù repository-’´ ’°÷Ä’¥’°’ø’∏÷Ç’¥ ’°’æ’•’¨’°÷Å÷Ä’∏÷Ç `Makefile`.

```Makefile
.PHONY: venv setup run lint type test dev prod logs ps down
venv:
	python -m venv .venv && . .venv/bin/activate && pip install -r requirements.txt
setup: venv
	cp -n .env.example .env || true
run:
	python -m app.telegram_bot.bot
lint:
	ruff .
type:
	mypy app
test:
	PYTHONPATH=. pytest -q
dev:
	docker compose -f devops/compose/docker-compose.dev.yml up --build
prod:
	docker compose -f devops/compose/docker-compose.prod.yml up -d --build
logs:
	docker compose -f devops/compose/docker-compose.prod.yml logs -f --tail=200
ps:
	docker compose -f devops/compose/docker-compose.prod.yml ps
down:
	docker compose -f devops/compose/docker-compose.prod.yml down --remove-orphans
```

---

## ü§ñ ’ç’¨’•’∑ ’∞÷Ä’°’¥’°’∂’∂’•÷Ä

- `/help` ‚Äî ÷Ö’£’ø’°’£’∏÷Ä’Æ’¥’°’∂ ’∞’°’Ø’´÷Ä’≥ ’∏÷Ç’≤’•÷Å’∏÷Ç’µ÷Å
- `/about` ‚Äî ’ø’°÷Ä’¢’•÷Ä’°’Ø, uptime, Python/aiogram info
- `/ping` ‚Äî pong
- `/id` ‚Äî User/Chat ID
- **¬´’Ñ’°÷Ñ÷Ä’•’¨ ’π’°’ø’®¬ª** ‚Äî ’æ’•÷Ä’°’¢’•’º’∂’∏÷Ç’¥ ’ß ’®’∂’©’°÷Å’´’Ø ’¶÷Ä’∏÷Ç’µ÷Å’´ ’∞’´’∑’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂’®

---

## üß™ ‘π’•’Ω’ø’°’æ’∏÷Ä’∏÷Ç’¥

‘π’•’Ω’ø’•÷Ä’® `tests/` ’∫’°’∂’°’Ø’∏÷Ç’¥ ’•’∂‚Ä§

- **unit** ‚Äî ’°’º’°’∂’±’´’∂ ’¥’∏’§’∏÷Ç’¨’∂’•÷Ä ÷á utilities
- **integration** ‚Äî handler + LLM ’´’∂’ø’•’£÷Ä’°÷Å’´’°, retry ’æ’°÷Ä÷Ñ
- **e2e** ‚Äî ’∞’´’¥’∂’°’Ø’°’∂ ’∞’∏’Ω÷Ñ’•÷Ä (mood/songs/movies/series/img)
- **security** ‚Äî input sanitization
- **performance** ‚Äî ’°÷Ä’°’£’°’£’∏÷Ä’Æ’∏÷Ç’©’µ’°’∂ ’π’°÷É’∏÷Ç’¥’∂’•÷Ä
- **regression** ‚Äî FSM/LLM ’Ø’°’µ’∏÷Ç’∂’∏÷Ç’©’µ’°’∂ ’©’•’Ω’ø’•÷Ä

’ï÷Ä’´’∂’°’Ø’∂’•÷Ä

```bash
pip install -r requirements-dev.txt
PYTHONPATH=. pytest -q
PYTHONPATH=. pytest --maxfail=1 --disable-warnings -q
bash tests/run_all_tests.sh
```

---

## üîÅ CI (GitHub Actions)

Workflow: `.github/workflows/ci.yml`

- **Jobs** (’•÷Ä’©’°’Ø’°’∂’∏÷Ç’©’µ’°’¥’¢)‚Ä§
  1. Ruff Lint
  2. Mypy (types)
  3. pip-audit (security)
  4. Ansible Syntax Check
  5. Unit tests + Coverage
  6. Docker Build (dev & prod)
  7. Compose Smoke (config + import sanity)
- **Artifacts**‚Ä§ ÷Å’°’∂’Ø’∏÷Ç’©’µ’°’∂ ’§’•’∫÷Ñ’∏÷Ç’¥ `coverage.xml`, Docker cache, logs
- **’Ü’∏’ø’´÷Ü’´’Ø’°÷Å’´’°**‚Ä§ Telegram ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ **View CI logs** ’Ø’∏’≥’°’Ø’∏’æ



---

## üöö CD (Self-hosted)

Workflow: `.github/workflows/cd.yml`

- **Trigger**‚Ä§ CI ’∞’°’ª’∏’≤ ’°’æ’°÷Ä’ø’´÷Å ’∞’•’ø’∏ (`main` ‚Üí deploy)
- **’î’°’µ’¨’•÷Ä**‚Ä§ self-hosted runner ‚Üí pull ‚Üí env refresh (GitHub Secrets) ‚Üí `docker compose -f devops/compose/docker-compose.prod.yml up -d --build` ‚Üí healthcheck
- **’Ü’∏’ø’´÷Ü’´’Ø’°÷Å’´’°**‚Ä§ Telegram ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ `RUNNING (healthy)` ’∞’°’Ω’ø’°’ø’∏÷Ç’¥’∏’æ + **View CD logs** ’∞’≤’∏÷Ç’¥’∏’æ



---

## üß∞ DevOps / Ansible Deploy

- Playbook’ù `devops/ansible/playbooks/deploy.yml`
- ‘ª’∂’æ’•’∂’ø’∏÷Ä’´’ù `devops/ansible/inventory/hosts.ini`
- ’å’∏’¨’ù `roles/deploy_app/tasks/main.yml` (Docker login/build/pull, Compose up)
- CI-’∏÷Ç’¥ ’Ø’°’ø’°÷Ä’æ’∏÷Ç’¥ ’ß **Ansible Syntax Check**; CD-’∏÷Ç’¥’ù ’´÷Ä’°’Ø’°’∂ deploy ’Ω’•÷Ä’æ’•÷Ä’´’∂

---

## üñºÔ∏è ’ç÷Ñ÷Ä’´’∂’∑’∏’©’•÷Ä

**’ç’Ø’´’¶’¢ / ’Ñ’•’∂’µ’∏÷Ç**

&#x20; &#x20;

**Mood Assistant ‚Üí ‘∏’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ ‚Üí ‘±÷Ä’§’µ’∏÷Ç’∂÷Ñ’∂’•÷Ä**

&#x20;&#x20;

**‘µ÷Ä’£’•÷Ä**

&#x20;

**’ñ’´’¨’¥’•÷Ä ÷á ’ç’•÷Ä’´’°’¨’∂’•÷Ä**

&#x20; &#x20;

**’Ü’Ø’°÷Ä ’£’•’∂’•÷Ä’°÷Å’´’°**

&#x20;

**GPT ‘∂÷Ä’∏÷Ç’µ÷Å + ’Ñ’°÷Ñ÷Ä’∏÷Ç’¥**

&#x20;

---

## üß± ’è’æ’µ’°’¨’∂’•÷Ä’´ ’∑’•÷Ä’ø

- ‘º’º’•’¨’°’µ’∂ `DATABASE_URL`’ù `sqlite:///db/memory.db` (mounted volume)
- ’Ä’´’¥’∂’°’Ø’°’∂ ’¥’∏’§’•’¨’ù `UserMemory(id, user_id, role, content, user_name, bot_name, last_mood, history)`
- `memory_service.py` ‚Äî ’∫’°’ø’¥’∏÷Ç’©’µ’°’∂ ’∫’°’∞’∫’°’∂’∏÷Ç’¥/’®’∂’©’•÷Ä÷Å’∏÷Ç’¥, ’®’Ω’ø ’Ø’°÷Ä’´÷Ñ’´ ’°’¥÷É’∏÷É’∏÷Ç’¥
- `db_session_tracker.py` ‚Äî DB ’Ω’•’Ω’´’°’∂’•÷Ä’´ ’æ’•÷Ä’°’∞’Ω’Ø’∏÷Ç’¥ ’©’•’Ω’ø’°’æ’∏÷Ä’¥’°’∂ ’™’°’¥’°’∂’°’Ø

---

## üîÑ FSM ’æ’´’≥’°’Ø’∂’•÷Ä

- `app/states/gpt_states.py` ‚Äî chatbot-’´ FSM transition-’∂’•÷Ä’´ ’Ω’°’∞’¥’°’∂’∏÷Ç’¥’∂’•÷Ä

---

## ü©∫ ‘±’º’∏’≤’ª’∏÷Ç’©’µ’∏÷Ç’∂ / Smoke

- `utils/trivial_check.py` ‚Äî ÷Ö’£’ø’°’£’∏÷Ä’Æ’æ’∏÷Ç’¥ ’ß smoke/health-check-’∏÷Ç’¥ ’°÷Ä’°’£ ’∞’°’Ω’ø’°’ø’¥’°’∂ ’∞’°’¥’°÷Ä

---

## üõ°Ô∏è ’Ñ’´’ª’°’∂’Ø’µ’°’¨’∂’•÷Ä

- `errors.py` ‚Äî catch-all ‚Üí user-friendly ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂
- `logging.py`, `request_id.py` ‚Äî request correlation ÷á structured logs

---

## üîí ‘±’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂

- ‘≥’°’≤’ø’∂’´÷Ñ’∂’•÷Ä’® ’¥’´’õ commit ’°÷Ä’°’ù ÷Ö’£’ø’°’£’∏÷Ä’Æ’´÷Ä **GitHub Secrets** ÷á ’ø’•’≤’°’µ’´’∂ `.env` (`.gitignore`)
- Token-’∂’•÷Ä’® ’π’•’∂ ’§’∏÷Ç÷Ä’Ω ’£÷Ä’æ’∏÷Ç’¥ logs-’∏÷Ç’¥
- Input sanitization-’® ’Æ’°’Æ’Ø’æ’°’Æ ’ß ’©’•’Ω’ø’•÷Ä’∏’æ
- ‘æ’°’∂÷Ä ’£’∏÷Ä’Æ’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’® rate-limit ’°÷Ä’° (Telegram-’´ ’Ω’°’∞’¥’°’∂’°÷É’°’Ø’∏÷Ç’¥’∂’•÷Ä’® ’∂’∏÷Ç’µ’∂’∫’•’Ω ’£’∏÷Ä’Æ’∏÷Ç’¥ ’•’∂)

---

## üè∑Ô∏è ’è’°÷Ä’¢’•÷Ä’°’Ø’°’æ’∏÷Ä’∏÷Ç’¥ ÷á ‘π’∏’≤’°÷Ä’Ø’∏÷Ç’¥’∂’•÷Ä

- **SemVer**’ù `MAJOR.MINOR.PATCH`
- **‘±’≤’¢’µ’∏÷Ç÷Ä**’ù `app/meta.py` (`/about`-’∏÷Ç’¥ ’•÷Ä÷á’°÷Å’∏’≤ ’ø’°÷Ä’¢’•÷Ä’°’Ø). ÷Å’°’∂’Ø’∏÷Ç’©’µ’°’∂ ’§’•’∫÷Ñ’∏÷Ç’¥’ù ’∂’°÷á `.env`-’∏÷Ç’¥ `BOT_VERSION`
- **Tag & Release**
  ```bash
  git commit -m "chore(release): vX.Y.Z"
  git tag -a vX.Y.Z -m "release vX.Y.Z"
  git push origin main --tags
  ```
  GitHub Release-’∏÷Ç’¥ ’£÷Ä’°’∂÷Å’´÷Ä ÷É’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’´ ’°’¥÷É’∏÷É’∏÷Ç’¥’®
- **Deploy**’ù CD-’∂ ’°’æ’ø’∏’¥’°’ø ’ß `main`-’´ ’∞’°’ª’∏’≤ CI-’´÷Å ’∞’•’ø’∏

---

## üõ†Ô∏è ‘Ω’°÷É’°’∂’∏÷Ç’¥’∂’•÷Ä’´ ’∏÷Ç’≤’•÷Å’∏÷Ç’µ÷Å

- **Bot-’® ’π’´ ’∫’°’ø’°’Ω’≠’°’∂’∏÷Ç’¥** ‚Üí ’Ω’ø’∏÷Ç’£’´÷Ä container-’´ ’æ’´’≥’°’Ø’®
  ```bash
  docker compose -f devops/compose/docker-compose.prod.yml ps
  docker logs -f compose-app-1 --tail=200
  ```
- **CI ’∞’°’≤’∏÷Ä’§’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’® ’π’´ ’£’°’¨’´’Ω** ‚Üí ’∞’°’Ω’ø’°’ø’´÷Ä chat id-’® `/id`-’∏’æ, ’Ω’ø’∏÷Ç’£’´÷Ä GitHub Secrets-’®
- **OpenAI 401/429** ‚Üí 401’ù ’¢’°’∂’°’¨’´’∂ ’Ω’≠’°’¨/’™’°’¥’Ø’•’ø’°’∂÷Å ’ß, 429’ù rate limit ‚Üí backoff
- **Image gen ’±’°’≠’∏’≤’∏÷Ç’¥** ‚Üí ’¥’´’°÷Å÷Ä’∏÷Ç image adapter-’®, ’∞’°’Ω’ø’°’ø’´÷Ä API ’¢’°’∂’°’¨’´’∂
- **Build failure** ‚Üí ÷É’∏÷Ä’±’´÷Ä ’ø’•’≤’∏÷Ç’¥
  ```bash
  docker build . -f devops/docker/app/Dockerfile
  ```
- **Compose config sanity**
  ```bash
  docker compose -f devops/compose/docker-compose.prod.yml config
  ```

---

## ‚ùì ’Ä’è’Ä

- **’Ñ’´’°’µ’∂ unit ’©’•’Ω’ø’•’û÷Ä** ‚Üí `pytest tests/unit -q`
- **’ç÷Ñ÷Ä’´’∂’∑’∏’©’•÷Ä’® ’∏÷Ä’ø’•’û’≤ ’•’∂** ‚Üí `docs/images/`
- **‘ª’∂’π’∫’•’û’Ω ÷É’∏’≠’•’¥ ’¥’∏’§’•’¨’∂’•÷Ä’®/’∫÷Ä’∏’¥’∫’ø’•÷Ä’®** ‚Üí ’≠’¥’¢’°’£÷Ä’´÷Ä `app/llm/assistant.py` ÷á ’∞’°÷Ä’°’Ø’´÷Å utilities
- **‘ª’∂’π’∫’•’û’Ω ’¶÷Ä’∏÷Ç÷Å’´ ’∞’´’∑’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂’® ’¥’°÷Ñ÷Ä’•’¥** ‚Üí ¬´’Ñ’°÷Ñ÷Ä’•’¨ ’π’°’ø’®¬ª ’Ø’°’¥ ’ª’∂’ª’´÷Ä `./db/`-’´ SQLite ÷Ü’°’µ’¨’® (dev)

---

## üß© ’ë’°’∂’Ø’°’¨’´ ’¢’°÷Ä’•’¨’°’æ’∏÷Ç’¥’∂’•÷Ä

- Dockerfile healthcheck’ù ’¥’•’Ø ’ø’∏’≤’∏’æ ‚úÖ
- Pre-commit hooks (ruff + mypy + pytest)
- Observability (’¥’•’ø÷Ä’´’Ø’°/’©÷Ä’•’µ’Ω’´’∂’£)
- Coverage badge + Codecov ’´’∂’ø’•’£÷Ä’∏÷Ç’¥

---

## üôå ’Ü’•÷Ä’§÷Ä’∏÷Ç’¥’∂’•÷Ä

PR-’∂’•÷Ä’∂ ’∏÷Ç issue-’∂’•÷Ä’® ’¥’´’∑’ø ’∏’≤’ª’∏÷Ç’∂’•’¨’´ ’•’∂‚Ä§

1. ‘≤’°÷Å’´÷Ä ’∂’Ø’°÷Ä’°’£÷Ä’°’Ø’°’∂ issue ’Ø’°’¥ PR
2. ‘≥’∏÷Ä’Æ’°÷Ä’Ø’´÷Ä `ruff`, `mypy`, `pytest`
3. ’ì’∏÷Ñ÷Ä, ’∞’Ω’ø’°’Ø ’Ø’∏’¥’´’ø’∂’•÷Ä

---

## üìú ‘º’´÷Å’•’∂’¶’´’°

‘±’æ’•’¨’°÷Å÷Ä’∏÷Ç `LICENSE` (÷Ö÷Ä.’ù MIT)
