name: Run Full Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-asyncio pytest-cov

    - name: ğŸ§¹ Run pre-commit (lint/format/security/types)
      uses: pre-commit/action@v3.0.1

    - name: ğŸ”§ Make test script executable
      run: chmod +x tests/run_all_tests.sh

    - name: ğŸ§ª Run all tests (with coverage)
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        ./tests/run_all_tests.sh || true

    - name: ğŸ“ Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ github.run_id }}
        path: tests/logs/test_check_logs
        if-no-files-found: ignore

    - name: ğŸ“ˆ Upload coverage.xml (artifact)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml
        path: coverage.xml
        if-no-files-found: ignore

    - name: ğŸŸ¢ Notify on Success with Button
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN_TEST_NOTIFIER }}/sendMessage \
        -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
        -d text="ğŸŸ¢ Ô¹Õ¥Õ½Õ¿Õ¥Ö€Õ¨ Õ°Õ¡Õ»Õ¸Õ²Õ¸Ö‚Õ©ÕµÕ¡Õ´Õ¢ Õ¡Õ¶ÖÕ¡Õ¶ âœ…\nğŸ”— ÕÕ¥Õ½ logs-Õ¨ GitHub Actions-Õ¸Ö‚Õ´Õ" \
        -d parse_mode="HTML" \
        -d reply_markup='{
              "inline_keyboard": [[
                  {
                      "text": "ğŸ“„ Ô²Õ¡ÖÕ¥Õ¬ Logs-Õ¨",
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
              ]]
            }'

    - name: âŒ Notify on Failure with Button
      if: failure()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN_TEST_NOTIFIER }}/sendMessage \
        -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
        -d text="ğŸš¨ Ô¹Õ¥Õ½Õ¿Õ¥Ö€Õ«Ö Õ¸Ö€Õ¸Õ·Õ¶Õ¥Ö€Õ¨ FAILED Õ¥Õ¶ âŒ\nğŸ” ÕÕ¥Õ½ logs-Õ¨ GitHub Actions-Õ¸Ö‚Õ´Õ" \
        -d parse_mode="HTML" \
        -d reply_markup='{
              "inline_keyboard": [[
                  {
                      "text": "ğŸ“„ Ô²Õ¡ÖÕ¥Õ¬ Logs-Õ¨",
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
              ]]
            }'
